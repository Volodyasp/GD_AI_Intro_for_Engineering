FROM python:3.11-slim-bookworm
LABEL authors="vladimirsuponin"

WORKDIR /app

COPY ./data_generation_backend/ ./

RUN pip install --upgrade pip && \
    pip install "poetry>=2.0,<3.0" && \
    poetry config virtualenvs.create false && \
    poetry install

ENV PYTHONPATH /app/src:/app/config

# Handling gcp creds
COPY ./gcp_creds/*.json /home/docker/.config/gcloud/

# ENV constants
ARG ALLOYDB_USER
ENV ALLOYDB_USER $ALLOYDB_USER
ARG ALLOYDB_HOST
ENV ALLOYDB_HOST $ALLOYDB_HOST
ARG ALLOYDB_DATABASE_NAME
ENV ALLOYDB_DATABASE_NAME $ALLOYDB_DATABASE_NAME
ARG ALLOYDB_PORT
ENV ALLOYDB_PORT $ALLOYDB_PORT
ARG ALLOYDB_PASSWORD
ENV ALLOYDB_PASSWORD $ALLOYDB_PASSWORD

ARG REDIS_HOST
ENV REDIS_HOST $REDIS_HOST
ARG REDIS_PORT
ENV REDIS_PORT $REDIS_PORT
ARG REDIS_PASSWORD
ENV REDIS_PASSWORD $REDIS_PASSWORD
ARG REDIS_DB
ENV REDIS_DB $REDIS_DB

ARG LANGFUSE_SECRET_KEY
ENV LANGFUSE_SECRET_KEY $LANGFUSE_SECRET_KEY
ARG LANGFUSE_PUBLIC_KEY
ENV LANGFUSE_PUBLIC_KEY $LANGFUSE_PUBLIC_KEY
ARG LANGFUSE_HOST
ENV LANGFUSE_HOST $LANGFUSE_HOST


CMD ["uvicorn", "src.main:app", "--workers", "4", "--host", "0.0.0.0", "--port", "8600"]

EXPOSE 8600
